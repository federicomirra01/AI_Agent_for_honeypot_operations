# VM4 Firewall/Router Container
FROM ubuntu:22.04

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install required packages
RUN apt-get update && apt-get install -y \
    iptables \
    iptables-persistent \
    tcpdump \
    python3 \
    python3-pip \
    net-tools \
    iproute2 \
    curl \
    rsyslog \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
RUN pip3 install flask

# Create directories
RUN mkdir -p /firewall/scripts \
    /firewall/logs \
    /firewall/rules \
    /var/spool/rsyslog

# Fix rsyslog permissions and configuration
RUN chown syslog:adm /var/spool/rsyslog \
    && chmod 755 /var/spool/rsyslog

# Create a custom rsyslog configuration that works better in containers
RUN echo '$ModLoad imuxsock' > /etc/rsyslog.conf && \
    echo '$ModLoad imklog' >> /etc/rsyslog.conf && \
    echo '$SystemLogSocketName /dev/log' >> /etc/rsyslog.conf && \
    echo '$KLogPermitNonKernelFacility on' >> /etc/rsyslog.conf && \
    echo '*.* /var/log/syslog' >> /etc/rsyslog.conf && \
    echo '& stop' >> /etc/rsyslog.conf

# Copy scripts
COPY firewall_scripts/firewall_api.py /firewall/scripts/
COPY firewall_scripts/packet_monitor.py /firewall/scripts/
COPY firewall_scripts/init_firewall.sh /firewall/scripts/
COPY firewall_scripts/setup_routing.sh /firewall/scripts/
COPY startup.sh /firewall/

# Make scripts executable
RUN chmod +x /firewall/scripts/*.sh /firewall/startup.sh

# Create log files
RUN touch /var/log/syslog /firewall/logs/firewall.log /firewall/logs/packet_monitor.log

# Set working directory
WORKDIR /firewall

# Enable IP forwarding in the container
RUN echo 'net.ipv4.ip_forward=1' >> /etc/sysctl.conf
RUN echo 'net.ipv6.conf.all.forwarding=1' >> /etc/sysctl.conf

# Expose ports
EXPOSE 5000 6000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:5000/health || exit 1

# Start the firewall container
CMD ["/firewall/startup.sh"]
