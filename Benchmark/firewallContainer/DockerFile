# VM4 Firewall/Router Container
FROM ubuntu:22.04

# Avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install essential networking and firewall tools
RUN apt-get update && apt-get install -y --fix-missing \
    iptables \
    iptables-persistent \
    iproute2 \
    iputils-ping \
    net-tools \
    tcpdump \
    netcat-openbsd \
    curl \
    wget \
    python3 \
    python3-pip \
    openssh-server \
    rsyslog \
    nano \
    vim \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Python packages for firewall management
RUN pip3 install flask requests psutil netifaces

# Create working directory
WORKDIR /firewall

# Create necessary directories
RUN mkdir -p /firewall/rules /firewall/logs /firewall/scripts

# Copy firewall management scripts
COPY firewall_scripts/ /firewall/scripts/
RUN chmod +x /firewall/scripts/*.sh
RUN chmod +x /firewall/scripts/*.py

# Enable IP forwarding
RUN echo 'net.ipv4.ip_forward=1' >> /etc/sysctl.conf
RUN echo 'net.ipv6.conf.all.forwarding=1' >> /etc/sysctl.conf

# Create startup script
COPY startup.sh /firewall/startup.sh
RUN chmod +x /firewall/startup.sh

# Expose ports for management
EXPOSE 5000

# Set environment variables
ENV ATTACKER_NETWORK=192.168.100.0/24
ENV HONEYPOT_NETWORK=172.20.0.0/24
ENV FIREWALL_MANAGEMENT_PORT=5000

RUN chmod 755 /firewall/scripts/*.sh /firewall/scripts/*.py
RUN touch /firewall/logs/firewall.log
RUN touch /var/log/syslog
# Start services
CMD ["/firewall/startup.sh"]
