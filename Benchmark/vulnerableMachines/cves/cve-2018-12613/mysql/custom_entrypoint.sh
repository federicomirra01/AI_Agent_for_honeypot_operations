#!/bin/bash

WEBSERVER=${WEBSERVER:-127.0.0.1}
echo "[INFO] Starting container with WEBSERVER=$WEBSERVER"

# Flush existing rules
iptables -F

# Set default policies - we'll start with ACCEPT and change INPUT to DROP later
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT

# Allow loopback traffic
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# Allow traffic from specific webserver IP for MySQL
iptables -A INPUT -p tcp --dport 3306 -s ${WEBSERVER} -j ACCEPT

# Allow established connections
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Now that we've set up our allow rules, set INPUT policy to DROP to block all other traffic
iptables -P INPUT DROP

echo "[INFO] Iptables configured to only allow connections from ${WEBSERVER}"

# Start MySQL
exec /usr/local/bin/docker-entrypoint.sh mysqld